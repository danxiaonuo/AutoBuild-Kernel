#=================================================
# https://github.com/danxiaonuo/AutoBuild-Kernel
# Description: Build OpenWrt using GitHub Actions
# Lisence: MIT
# Author: danxiaonuo
# Blog: https://www.danxiaonuo.com
#=================================================
# ç¼–è¯‘çš„åç§°
name: ç¼–è¯‘build-bbrplus-kernelå†…æ ¸

# è®¾ç½®è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      name:
        description: 'build-bbrplus-kernel'
        required: true
        default: 'ç¼–è¯‘build-bbrplus-kernelå†…æ ¸'

  # ç‚¹èµâ˜†Starè§¦å‘ç¼–è¯‘
  watch:
     types: [started]

# ç¯å¢ƒå˜é‡
env:
   # æºç ä»“åº“åœ°å€
   REPO_URL: https://github.com/torvalds/linux
   # æºç åˆ†æ”¯
   REPO_BRANCH: master
   # è‡ªå®šä¹‰æ‰§è¡Œè„šæœ¬åç§°
   DIY_SH: scripts/build-bbrplus-kernel.sh
   # æ—¶åŒºè®¾ç½®
   TZ: Asia/Shanghai
   # SSH è¿æ¥ActionsåŠŸèƒ½
   SSH_ACTIONS: false
   # ä¸Šä¼ å›ºä»¶åˆ°å¥¶ç‰›å¿«ä¼ 
   UPLOAD_COWTRANSFER: true
   # ä¸Šä¼ å›ºä»¶åˆ° WeTransfer
   UPLOAD_WETRANSFER: true
   # Github ç”¨æˆ·å
   GITHUB_USER_NAME: danxiaonuo
   # Github é‚®ç®±
   GITHUB_USER_EMAIL: ${{ secrets.EMAIL }}
   # Github
   GITHUB: github.com/danxiaonuo/AutoBuild-Kernel.git
   # åˆ›å»º+ä¸Šä¼ å‘å¸ƒ
   CREATE_RELEASE: true
   # ç¼–è¯‘è€…
   BUILD_USER: danxiaonuo
   # å¾®ä¿¡é€šçŸ¥
   SEND_WECHAT_MSG: true
   # å‘è¡Œå›ºä»¶åœ°å€
   GITHUB_RELEASE: https://github.com/danxiaonuo/AutoBuild-Kernel/releases

# ä»»åŠ¡é›†
jobs:
  bbrplus:
    # é€‰æ‹©è™šæ‹Ÿç¯å¢ƒ
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

   # è¿è¡Œæ­¥éª¤
    steps:
    
    # æ£€å‡ºå„ä¸ªä»£ç æ¨¡å—
    - name: æ£€å‡ºå„ä¸ªä»£ç æ¨¡å—
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        
    # åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ
    - name: åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # åˆ é™¤dockeré•œåƒ
        sudo -E docker rmi -f $(docker images -aq)
        # åˆ é™¤æº
        sudo -E rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        # æ›´æ¢é•œåƒ
        sudo -E sed -i s#http://*.*ubuntu.com#https://mirrors.ustc.edu.cn#g /etc/apt/sources.list
        # æ›´æ–°æº
        sudo -E apt-get -qqy update
        # æ›´æ–°ç³»ç»Ÿ
        sudo -E apt-get -qqy update && sudo -E apt-get -qqy dist-upgrade
        # å®‰è£…ä¾èµ–
        sudo -E apt-get -qqy install bash-completion conntrack ipset ipvsadm jq libseccomp2 nfs-common psmisc rsync socat make gcc gcc-multilib g++-multilib g++-multilib build-essential asciidoc binutils gawk gettext libncurses5-dev libz-dev autoconf automake openssl locate libtool autopoint device-tree-compiler patch sysstat firewalld chrony ntpdate tcpdump telnet lsof iftop htop unzip zip wget curl lvm2 tree axel zlib1g-dev libc6-dev-i386 subversion flex uglifyjs net-tools vim lrzsz libssl-dev texinfo libglib2.0-dev xmlto upx libelf-dev rsyslog bash-completion git tmux bzip2 python2.7 python3 p7zip p7zip-full msmtp qemu-utils antlr3 gperf swig zsh nano screen gnupg ca-certificates uuid-runtime tzdata openssh-server lrzsz xz-utils pkg-config bison bc dwarves bridge-utils
        # æ¸…ç†ä¾èµ–
        sudo -E apt-get -qqy autoremove --purge && sudo -E apt-get -qqy autoclean
        # è®¾ç½®æ—¶åŒº
        sudo -E timedatectl set-timezone "$TZ"
        
    # å…‹éš†æºç 
    - name: å…‹éš†æºç 
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH kernel
        cd kernel
        wget https://raw.githubusercontent.com/danxiaonuo/AutoBuild-Kernel/main/patch/xiaonuo.patch
        patch -p1 < xiaonuo.patch
        echo "KERNELROOT=$PWD" >> $GITHUB_ENV
        echo "::set-output name=KERNELROOT::$(echo $PWD)"
        echo "useVersionInfo=$(git show -s --date=short --format="ä½œè€…: %an<br/>æ—¥æœŸ: %cd<br/>Commit: %s")" >> $GITHUB_ENV
        echo "DATE=$(TZ=CST-8 date "+%Yå¹´%mæœˆ%då·-%Hç‚¹%Måˆ†%Sç§’")" >> $GITHUB_ENV
        echo "RELEASE_DATE=$(TZ=CST-8 date +"%Yå¹´%mæœˆ%då·-%Hç‚¹")" >> $GITHUB_ENV
            
   # ä½¿ç”¨æ—§å†…æ ¸é…ç½®èœå•
    - name: ä½¿ç”¨æ—§å†…æ ¸é…ç½®èœå•
      working-directory: ./kernel
      run:  |
        yes "" | make oldconfig
  
    # ç¦ç”¨ç­¾åè°ƒè¯•
    - name: ç¦ç”¨ç­¾åè°ƒè¯•
      working-directory: ./kernel
      run:  |
         scripts/config --disable SECURITY_LOCKDOWN_LSM
         scripts/config --disable DEBUG_INFO
         scripts/config --disable MODULE_SIG
         
    # åŠ è½½è‡ªå®šä¹‰è„šæœ¬  
    - name: åŠ è½½è‡ªå®šä¹‰è„šæœ¬
      run: |
        chmod +x $DIY_SH
        cd kernel
        ../$DIY_SH
  
    # ç¼–è¯‘å†…æ ¸
    - name: ç¼–è¯‘å†…æ ¸
      working-directory: ./kernel
      id: compile
      run: |
         yes "11" | make bindeb-pkg -o $KERNELROOT -j$(($(nproc)+1))
         echo "::set-output name=status::success"
    
    # æ•´ç†æ–‡ä»¶
    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        mkdir -pv output 
        mv linux-* output/
        cp -rf kernel/.config output/config
        cd output/
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "::set-output name=FIRMWARE::$(echo $PWD)"
        echo "::set-output name=status::success"
    
    # ç”Ÿæˆæ ‡ç­¾
    - name: ç”Ÿæˆæ ‡ç­¾
      id: tag
      if: steps.compile.outputs.status == 'success' && env.CREATE_RELEASE == 'true' && !cancelled()
      run: |
        echo "RELEASE_TAG=bbrplus-kernel-${{ env.RELEASE_DATE }}" >> $GITHUB_ENV
        echo "::set-output name=status::success"
        
    # ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v2
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: ${{ env.RELEASE_TAG }}
        path: ${{ env.FIRMWARE }}
    
    # å‘è¡Œå›ºä»¶
    - name: å‘è¡Œå›ºä»¶
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.KERNEL_TOKEN }}
      with:
        name: è‡ªåŠ¨ç¼–è¯‘ / ${{ env.RELEASE_TAG }}
        tag_name: ${{ env.RELEASE_TAG }}
        body: |            
            1ã€æœ¬å†…æ ¸ä¸ºè‡ªåŠ¨ç¼–è¯‘
            2ã€å‘è¡Œç‰ˆä¸­åªæä¾›å®Œæ•´çš„å†…æ ¸
            3ã€æºç ï¼š${{ env.REPO_URL }}
            -- Build by ${{ env.BUILD_USER }} @ with Github Action on ${{ env.RELEASE_TAG }}
            ğŸš€ Auto build | è‡ªåŠ¨ç¼–è¯‘
            ğŸ”— [Cowtransfer | å¥¶ç‰›å¿«ä¼ ](${{ steps.cowtransfer.outputs.COWTRANSFER_URL }}) 
            ğŸ”— [WeTransfer](${{ steps.wetransfer.outputs.WETRANSFER_URL }})       
            å½“å‰ä½¿ç”¨ç‰ˆæœ¬:            
            ${{ env.useVersionInfo }}
            ${{ github.event.commits[0].message }}
        files: ${{ env.FIRMWARE }}/*
        
    # å¾®ä¿¡é€šçŸ¥
    - name: å¾®ä¿¡é€šçŸ¥
      if: steps.compile.outputs.status == 'success' && env.SEND_WECHAT_MSG == 'true' && !cancelled()
      uses: emon100/Action-Serverchan@master
      with:
        SCKEY: ${{ secrets.SCKEY }}
        text: ${{ env.RELEASE_TAG }}å†…æ ¸ç¼–è¯‘å®Œæˆï¼
        desp: å†…æ ¸åç§°:${{ env.RELEASE_TAG }} å†…æ ¸åœ°å€:${{ env.GITHUB_RELEASE }}/tag/${{ env.RELEASE_TAG }}
    
    # åˆ é™¤æ—§çš„GitHub-workflow    
    - name: åˆ é™¤æ—§çš„GitHub-workflow
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 1    #ä¿ç•™å¤šå°‘ä¸ªworkflowä¸åˆ é™¤  
        
    - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
      uses: dev-drprasad/delete-older-releases@v0.1.0
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
      with:
        keep_latest: 1         #ä¿ç•™å¤šå°‘ä¸ªreleasesä¸åˆ é™¤
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.KERNEL_TOKEN }}
